jQuery(document).ready(function($){

    $('#barcode-scan-result').dialog({
        title: 'Result',
        dialogClass: 'wp-dialog',
        autoOpen: false,
        draggable: false,
        width: 700,
        modal: true,
        resizable: false,
        closeOnEscape: true,
        position: {
            my: "center",
            at: "center",
            of: window
        },
        open: function () {
            // close dialog by clicking the overlay behind it
            $('.ui-widget-overlay').bind('click', function(){
            $('#my-dialog').dialog('close');
            })
        },
        create: function () {
            // style fix for WordPress admin
            $('.ui-dialog-titlebar-close').addClass('ui-button');
        },
    });

})

const OrderBarcode = function() {
    const form          = document.querySelector( '#barcode-scan-form #barcode-scan' );
    const button          = document.querySelector( '#barcode-scan-form input[type="submit"]' );
    const loader        = document.getElementById( 'barcode-scan-loader' );
    const input         = document.querySelector( '#barcode-scan-form input#scan-code' );
    const displayResult = document.getElementById( 'barcode-scan-result' );
    if(typeof(input) === 'undefined' || input == null) return;
    // Focus on barcode input field.
    input.focus();

    button.addEventListener( 'click', ( event ) => {
        event.preventDefault();

        // Show the loader.
        loader.style.display = 'block';

        // Empty existing results.
        displayResult.innerHTML = '';

        const inputAction = document.querySelector( '#barcode-scan-form #scan-action' ).value;
        const request     = new XMLHttpRequest();

        request.open( 'POST', wc_order_barcodes.ajaxurl, true );
        request.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8' );
        request.setRequestHeader( 'X-Requested-With', 'XMLHttpRequest' );
        request.onreadystatechange = function() {
            if ( this.readyState === XMLHttpRequest.DONE && 200 === this.status ) {
                // Focus on barcode input field.
                input.focus();

                if ( ! request.response ) {
                    return;
                }

                // Hide the loader.
                loader.style.display = 'none';

                // Display response.
                displayResult.innerHTML = request.response;
                jQuery('#barcode-scan-result').dialog('open');
            }

            return;
        }

        request.send( encodeURI( 'action=scan_barcode&barcode_input=' + input.value + '&scan_action=' + inputAction + '&woocommerce_order_barcodes_scan_nonce=' + wc_order_barcodes.scan_nonce ) );
    } );

    onScan.attachTo( document, {
        reactToPaste: false,
        onScan: function( sCode, iQty ) {
            form.dispatchEvent( new Event( 'submit' ) );
        }
    } );
};

window.onload = OrderBarcode;
